version: "3.9"

services:
  postgres:
    image: postgres:16
    container_name: oa_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-oa_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-oa_pass}
      POSTGRES_DB: ${POSTGRES_DB:-oa_db}
    ports:
      - "5432:5432"
    volumes:
      - oa_pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-oa_user} -d ${POSTGRES_DB:-oa_db}"]
      interval: 5s
      timeout: 3s
      retries: 20

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: oa_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@local.test}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin123}
    ports:
      - "127.0.0.1:5050:80"
    volumes:
      - oa_pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy

  qdrant:
    image: qdrant/qdrant:v1.11.5
    container_name: oa_qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - oa_qdrant_data:/qdrant/storage

  mailpit:
    image: axllent/mailpit:v1.20.3
    container_name: oa_mailpit
    restart: unless-stopped
    ports:
      - "127.0.0.1:1025:1025"
      - "127.0.0.1:8025:8025"

  backend:
    image: ghcr.io/maciejmar/office-assistant-backend:latest
    container_name: oa_backend
    restart: unless-stopped
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER:-oa_user}:${POSTGRES_PASSWORD:-oa_pass}@postgres:5432/${POSTGRES_DB:-oa_db}
      JWT_SECRET: ${JWT_SECRET:-change-me}
      CORS_ORIGINS: ${CORS_ORIGINS:-https://office-assistant.webaby.io}
      N8N_WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://n8n:5678/webhook/office-assistant/newsletter/generate}
    volumes:
      - oa_storage:/app/storage
    ports:
      - "127.0.0.1:8001:8001"
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    image: ghcr.io/maciejmar/office-assistant-frontend:latest
    container_name: oa_frontend
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      - backend

  n8n:
    image: n8nio/n8n:1.36.4
    container_name: oa_n8n
    restart: unless-stopped
    environment:
      N8N_HOST: ${N8N_HOST:-office-assistant.webaby.io}
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      WEBHOOK_URL: ${N8N_WEBHOOK_URL_PUBLIC:-https://office-assistant.webaby.io}
      N8N_DIAGNOSTICS_ENABLED: "false"
      N8N_PERSONALIZATION_ENABLED: "false"
    ports:
      - "127.0.0.1:5678:5678"
    volumes:
      - oa_n8n_data:/home/node/.n8n
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  oa_pg_data:
  oa_pgadmin_data:
  oa_qdrant_data:
  oa_n8n_data:
  oa_storage:
